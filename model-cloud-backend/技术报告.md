# Model Cloud 后端技术报告

## 一、项目概述

Model Cloud 后端是一个基于 Spring Boot 3.1.5 的云端模型管理系统后端服务，采用前后端分离架构，提供 RESTful API 接口，支持模型的上传、管理、审核、分发等功能。系统集成了 Gitea 作为版本控制系统，使用 MySQL 存储结构化数据，MongoDB 存储非结构化数据，Redis 提供缓存服务。

## 二、技术栈总览

### 2.1 核心框架
- **Spring Boot 3.1.5**: 应用框架
- **Spring Security**: 安全框架
- **Spring Web MVC**: Web 层框架
- **Spring Data**: 数据访问抽象层

### 2.2 数据存储
- **MySQL 8.0+**: 关系型数据库
- **MongoDB 6.0+**: NoSQL 文档数据库
- **Redis 6.0+**: 内存缓存数据库

### 2.3 ORM 框架
- **MyBatis-Flex 1.11.1**: 轻量级 ORM 框架

### 2.4 安全认证
- **JWT (JSON Web Token)**: 无状态身份认证
- **BCrypt**: 密码加密

### 2.5 工具库
- **Hutool 5.8.23**: Java 工具类库
- **FastJSON2 2.0.43**: JSON 处理库
- **Apache Commons**: 通用工具库

### 2.6 外部集成
- **Gitea API 1.18.0**: Git 仓库管理 API

### 2.7 构建工具
- **Maven**: 项目构建和依赖管理

## 三、核心技术详解

### 3.1 Spring Boot 3.1.5

#### 3.1.1 技术概述
Spring Boot 是 Spring 框架的扩展，通过自动配置和约定优于配置的理念，简化了 Spring 应用的开发和部署。

#### 3.1.2 工作原理
1. **自动配置机制**: 通过 `@SpringBootApplication` 注解触发自动配置
   - 扫描 `@Component`、`@Service`、`@Repository` 等注解
   - 根据类路径中的依赖自动配置 Bean
   - 通过 `application.yml` 进行外部化配置

2. **启动流程**:
   ```java
   @SpringBootApplication
   @EnableMongoRepositories("com.modelcloud.modules.**.repository")
   @EnableAsync
   public class ModelCloudApplication {
       public static void main(String[] args) {
           SpringApplication.run(ModelCloudApplication.class, args);
       }
   }
   ```
   - 创建 Spring 应用上下文
   - 加载配置文件和 Bean 定义
   - 启动内嵌 Tomcat 服务器（默认端口 8080）

3. **配置管理**:
   - `application.yml`: 主配置文件
   - `application-dev.yml`: 开发环境配置
   - `application-prod.yml`: 生产环境配置
   - 通过 `spring.profiles.active` 激活不同环境

#### 3.1.3 在项目中的应用
- **应用入口**: `ModelCloudApplication.java` 作为启动类
- **上下文路径**: `/api`（通过 `server.servlet.context-path` 配置）
- **端口配置**: 8080（可通过配置文件修改）
- **多环境支持**: 开发/生产环境配置分离

### 3.2 Spring Security

#### 3.2.1 技术概述
Spring Security 是 Spring 生态系统的安全框架，提供认证、授权、防护攻击等功能。

#### 3.2.2 工作原理
1. **过滤器链机制**:
   - Spring Security 通过一系列过滤器链处理请求
   - `JwtAuthenticationFilter` 作为自定义过滤器插入到过滤器链中
   - 在 `UsernamePasswordAuthenticationFilter` 之前执行

2. **配置实现** (`SecurityConfig.java`):
   ```java
   @Bean
   public SecurityFilterChain securityFilterChain(HttpSecurity http) {
       http
           .csrf(AbstractHttpConfigurer::disable)  // 禁用CSRF（前后端分离）
           .cors(cors -> cors.configurationSource(corsConfigurationSource()))
           .sessionManagement(session -> 
               session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))  // 无状态
           .authorizeHttpRequests(auth -> auth
               .requestMatchers("/auth/login", "/auth/register", ...).permitAll()
               .anyRequest().authenticated()
           )
           .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
       return http.build();
   }
   ```

3. **JWT 认证流程**:
   - 用户登录成功后生成 JWT Token
   - 前端将 Token 放在 `Authorization: Bearer <token>` 请求头中
   - `JwtAuthenticationFilter` 拦截请求，提取并验证 Token
   - 验证通过后，将用户信息设置到 `SecurityContext` 中
   - 后续请求可通过 `SecurityUtils.getCurrentUserId()` 获取当前用户

4. **CORS 配置**:
   - 允许 `http://localhost:5173` 和 `http://localhost:3000` 跨域访问
   - 支持 GET、POST、PUT、DELETE、OPTIONS 方法
   - 允许携带凭证（cookies）

#### 3.2.3 在项目中的应用
- **公开接口**: `/auth/login`、`/auth/register`、`/auth/captcha`、`/public/**`
- **受保护接口**: 其他所有接口需要 JWT 认证
- **无状态设计**: 使用 JWT 而非 Session，支持水平扩展

### 3.3 JWT (JSON Web Token)

#### 3.3.1 技术概述
JWT 是一种开放标准（RFC 7519），用于在各方之间安全地传输信息。Token 由三部分组成：Header、Payload、Signature。

#### 3.3.2 工作原理
1. **Token 结构**:
   - **Header**: 包含算法类型（如 HS256）和 Token 类型（JWT）
   - **Payload**: 包含声明（claims），如用户ID、用户名、过期时间
   - **Signature**: 使用密钥对 Header 和 Payload 进行签名

2. **生成 Token** (`JwtUtil.java`):
   ```java
   public String generateToken(Long userId, String username) {
       Map<String, Object> claims = new HashMap<>();
       claims.put("userId", userId);
       claims.put("username", username);
       
       SecretKey key = Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8));
       return Jwts.builder()
           .claims(claims)
           .issuedAt(new Date())
           .expiration(new Date(now.getTime() + expiration))
           .signWith(key)
           .compact();
   }
   ```

3. **验证 Token**:
   - 使用相同的密钥解析 Token
   - 验证签名是否有效
   - 检查过期时间
   - 提取用户信息

4. **配置参数**:
   - `secret`: 密钥（32字节以上）
   - `expiration`: Token 过期时间（默认 24 小时，86400000 毫秒）
   - `header`: 请求头名称（Authorization）
   - `token-prefix`: Token 前缀（Bearer）

#### 3.3.3 在项目中的应用
- **登录流程**: 用户登录成功后返回 JWT Token
- **请求认证**: 每个需要认证的请求携带 Token
- **用户信息提取**: 通过 `SecurityUtils.getCurrentUserId()` 获取当前用户ID

### 3.4 MyBatis-Flex

#### 3.4.1 技术概述
MyBatis-Flex 是一个基于 MyBatis 的增强框架，提供了更灵活的查询方式和更强大的功能。

#### 3.4.2 工作原理
1. **Mapper 接口**:
   - 继承 `BaseMapper<T>` 获得基础 CRUD 方法
   - 自定义方法通过 XML 或注解实现

2. **查询构建器**:
   ```java
   QueryWrapper query = QueryWrapper.create()
       .select()
       .from(BS_MODEL)
       .where(BS_MODEL.NAME.like(keyword))
       .and(BS_MODEL.IS_DEL.eq(0))
       .orderBy(BS_MODEL.CREATE_TIME.desc());
   Page<BsModel> page = bsModelMapper.paginate(pageNum, pageSize, query);
   ```

3. **逻辑删除**:
   - 配置 `is_del` 字段为逻辑删除字段
   - 删除操作自动更新 `is_del` 字段而非物理删除
   - 查询时自动过滤已删除记录

4. **配置** (`MybatisConfig.java`):
   ```java
   @MapperScan({"com.modelcloud.modules.auth.mapper", 
                "com.modelcloud.modules.business.mapper", 
                "com.modelcloud.modules.sys.mapper"})
   ```

#### 3.4.3 在项目中的应用
- **数据访问层**: 所有数据库操作通过 Mapper 接口
- **分页查询**: 使用 `Page<T>` 进行分页
- **条件查询**: 使用 `QueryWrapper` 构建复杂查询条件
- **逻辑删除**: 所有表支持逻辑删除，保证数据安全

### 3.5 MySQL 数据库

#### 3.5.1 技术概述
MySQL 是关系型数据库管理系统，用于存储结构化数据。

#### 3.5.2 工作原理
1. **连接池** (HikariCP):
   - `minimum-idle`: 最小空闲连接数（5）
   - `maximum-pool-size`: 最大连接数（20）
   - `connection-timeout`: 连接超时时间（30秒）
   - `max-lifetime`: 连接最大生存时间（30分钟）

2. **数据源配置**:
   ```yaml
   spring:
     datasource:
       driver-class-name: com.mysql.cj.jdbc.Driver
       url: jdbc:mysql://localhost:3307/model_cloud?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
       username: root
       password: 123456
   ```

3. **事务管理**:
   - 使用 `@Transactional` 注解管理事务
   - 支持声明式事务
   - 默认传播行为：REQUIRED

#### 3.5.3 在项目中的应用
- **用户管理**: `sys_user`、`sys_role`、`sys_user_role` 表
- **模型管理**: `bs_model`、`bs_model_collect`、`bs_model_label` 表
- **系统统计**: `sys_site_stat` 表存储站点统计数据

### 3.6 MongoDB

#### 3.6.1 技术概述
MongoDB 是 NoSQL 文档数据库，用于存储非结构化或半结构化数据。

#### 3.6.2 工作原理
1. **连接配置**:
   ```yaml
   spring:
     data:
       mongodb:
         uri: mongodb://localhost:27017/model_cloud
         database: model_cloud
   ```

2. **Repository 模式**:
   - 通过 `@EnableMongoRepositories` 启用 MongoDB Repository
   - 继承 `MongoRepository<T, ID>` 获得基础 CRUD 方法

3. **文档存储**:
   - 以 BSON（Binary JSON）格式存储文档
   - 支持嵌套文档和数组
   - 灵活的 schema 设计

#### 3.6.3 在项目中的应用
- **模型参数**: 存储模型的动态参数配置（JSON 格式）
- **模型模板**: 存储模型模板信息
- **扩展性**: 支持未来存储更多非结构化数据

### 3.7 Redis

#### 3.7.1 技术概述
Redis 是内存键值数据库，用于缓存和会话存储。

#### 3.7.2 工作原理
1. **连接池配置** (Lettuce):
   ```yaml
   spring:
     data:
       redis:
         host: localhost
         port: 6379
         timeout: 5000ms
         lettuce:
           pool:
             max-active: 8
             max-idle: 8
             min-idle: 0
   ```

2. **使用场景**:
   - **验证码存储**: 存储验证码 key-value 对，设置过期时间
   - **缓存热点数据**: 缓存频繁访问的数据
   - **分布式锁**: 实现分布式环境下的锁机制

#### 3.7.3 在项目中的应用
- **验证码服务**: `CaptchaService` 使用 Redis 存储验证码
- **缓存**: 可缓存用户信息、模型列表等热点数据

### 3.8 Gitea API 集成

#### 3.8.1 技术概述
Gitea 是一个轻量级的 Git 服务，提供类似 GitHub 的功能。项目通过 Gitea API 管理模型文件的版本控制。

#### 3.8.2 工作原理
1. **API 调用**:
   - 使用 Hutool 的 `HttpRequest` 发送 HTTP 请求
   - 通过 Token 认证（`Authorization: token <token>`）
   - 使用 JSON 格式传输数据

2. **核心功能** (`GiteaService.java`):
   - **创建仓库**: `POST /api/v1/user/repos`
   - **上传文件**: `POST /api/v1/repos/{owner}/{repo}/contents/{path}`
   - **更新文件**: `PUT /api/v1/repos/{owner}/{repo}/contents/{path}`
   - **获取文件**: `GET /api/v1/repos/{owner}/{repo}/contents/{path}`
   - **删除仓库**: `DELETE /api/v1/repos/{owner}/{repo}`

3. **文件存储结构**:
   ```
   models-{username}/
     └── model-{modelName}-{date}/
         ├── {modelFile}
         ├── cover-{uuid}.{ext}
         └── README.md
   ```

4. **Base64 编码**:
   - Gitea API 要求文件内容使用 Base64 编码
   - 上传时编码，下载时解码

#### 3.8.3 在项目中的应用
- **模型文件存储**: 每个用户的模型存储在独立的 Gitea 仓库中
- **版本控制**: 每次更新都会创建新的 commit
- **文件下载**: 通过 Gitea 的 raw 链接提供文件下载
- **仓库管理**: 自动创建用户仓库，删除模型时删除对应仓库

### 3.9 Hutool 工具库

#### 3.9.1 技术概述
Hutool 是一个 Java 工具类库，提供了丰富的工具方法。

#### 3.9.2 在项目中的应用
- **HTTP 请求**: `HttpRequest` 用于调用 Gitea API
- **JSON 处理**: `JSONUtil` 用于 JSON 序列化和反序列化
- **字符串工具**: `StrUtil` 用于字符串操作
- **ID 生成**: `IdUtil` 用于生成 UUID
- **URL 编码**: `URLUtil` 用于 URL 编码

### 3.10 FastJSON2

#### 3.10.1 技术概述
FastJSON2 是阿里巴巴开源的 JSON 处理库，性能优异。

#### 3.10.2 在项目中的应用
- **JSON 序列化**: 将 Java 对象转换为 JSON 字符串
- **JSON 反序列化**: 将 JSON 字符串转换为 Java 对象
- **API 响应**: 统一使用 JSON 格式返回数据

### 3.11 异步处理

#### 3.11.1 技术概述
Spring 的 `@Async` 注解支持异步方法执行。

#### 3.11.2 工作原理
1. **配置** (`AsyncConfig.java`):
   ```java
   @Configuration
   @EnableAsync
   public class AsyncConfig {
       @Bean(name = "sseTaskExecutor")
       public Executor sseTaskExecutor() {
           ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
           executor.setCorePoolSize(5);
           executor.setMaxPoolSize(10);
           executor.setQueueCapacity(100);
           return executor;
       }
   }
   ```

2. **使用场景**:
   - **SSE 事件推送**: 异步推送服务器发送事件
   - **耗时操作**: 文件上传、数据处理等耗时操作

#### 3.11.3 在项目中的应用
- **SSE 控制器**: 使用异步线程池处理 SSE 连接
- **事件处理**: 异步处理访问统计等事件

### 3.12 全局异常处理

#### 3.12.1 技术概述
使用 `@RestControllerAdvice` 实现全局异常处理。

#### 3.12.2 工作原理
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(BusinessException.class)
    public Result<?> handleBusinessException(BusinessException e) {
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<?> handleException(Exception e) {
        log.error("系统异常: ", e);
        return Result.error(ResultCode.ERROR.getCode(), "系统异常，请联系管理员");
    }
}
```

#### 3.12.3 在项目中的应用
- **统一错误响应**: 所有异常统一返回 `Result` 格式
- **错误日志**: 记录异常日志便于排查问题
- **友好提示**: 返回用户友好的错误信息

## 四、架构设计

### 4.1 分层架构

```
Controller 层 (API 接口)
    ↓
Service 层 (业务逻辑)
    ↓
Mapper 层 (数据访问)
    ↓
Database (MySQL/MongoDB)
```

### 4.2 模块划分

1. **common 模块**: 公共组件
   - `config`: 配置类
   - `exception`: 异常处理
   - `security`: 安全相关
   - `tools`: 工具类
   - `web`: Web 相关（请求/响应封装）

2. **auth 模块**: 认证授权
   - `controller`: 认证接口
   - `service`: 认证服务
   - `model`: 数据传输对象

3. **business 模块**: 业务模块
   - `controller`: 业务接口
   - `service`: 业务服务
   - `mapper`: 数据访问
   - `model`: 领域模型

4. **sys 模块**: 系统管理
   - `controller`: 系统管理接口
   - `service`: 系统服务
   - `mapper`: 数据访问
   - `model`: 领域模型

### 4.3 数据流

1. **请求流程**:
   ```
   客户端请求 → JwtAuthenticationFilter → Controller → Service → Mapper → Database
   ```

2. **响应流程**:
   ```
   Database → Mapper → Service → Controller → GlobalExceptionHandler → 客户端响应
   ```

## 五、核心功能实现

### 5.1 用户认证

1. **注册流程**:
   - 验证用户名唯一性
   - 密码使用 BCrypt 加密
   - 创建用户记录
   - 分配默认角色

2. **登录流程**:
   - 验证验证码
   - 验证用户名和密码
   - 生成 JWT Token
   - 返回用户信息和 Token
   - 更新站点访问统计

3. **Token 验证**:
   - 从请求头提取 Token
   - 验证 Token 有效性
   - 提取用户信息
   - 设置到 SecurityContext

### 5.2 模型管理

1. **上传模型**:
   - 验证用户登录状态
   - 确保用户 Gitea 仓库存在
   - 创建模型文件夹（格式：`model-{name}-{date}`）
   - 上传模型文件到 Gitea
   - 上传封面图片到 Gitea
   - 生成 README.md 文件
   - 保存模型信息到数据库

2. **模型列表**:
   - 支持分页查询
   - 支持关键词搜索
   - 支持标签筛选
   - 支持排序（按创建时间）

3. **模型详情**:
   - 查询模型基本信息
   - 查询模型文件信息
   - 查询模型标签
   - 查询收藏状态

4. **删除模型**:
   - 验证权限（仅上传者可删除）
   - 删除 Gitea 仓库中的文件
   - 删除数据库记录（逻辑删除）
   - 删除相关收藏记录

### 5.3 Gitea 集成

1. **仓库管理**:
   - 每个用户对应一个仓库（`models-{username}`）
   - 自动创建仓库（不存在时）
   - 支持删除仓库

2. **文件管理**:
   - 上传文件（Base64 编码）
   - 更新文件（需要 SHA 值）
   - 获取文件内容（Base64 解码）
   - 获取文件下载链接

3. **版本控制**:
   - 每次操作创建 commit
   - 支持分支管理（main/master）
   - 提供文件历史记录

### 5.4 站点统计

1. **访问统计**:
   - 记录总访问次数
   - 记录用户登录次数
   - 使用事件机制异步更新

2. **统计查询**:
   - 查询总访问量
   - 查询模型总数
   - 查询用户总数

## 六、安全机制

### 6.1 密码安全
- 使用 BCrypt 加密算法
- 密码不存储明文
- 支持密码强度验证

### 6.2 认证安全
- JWT Token 签名验证
- Token 过期机制
- 请求头认证

### 6.3 接口安全
- Spring Security 保护
- CORS 配置
- CSRF 防护（前后端分离可禁用）

### 6.4 数据安全
- 逻辑删除机制
- SQL 注入防护（MyBatis 参数化查询）
- XSS 防护（前后端分离）

## 七、性能优化

### 7.1 数据库优化
- 连接池配置（HikariCP）
- 索引优化
- 分页查询

### 7.2 缓存优化
- Redis 缓存验证码
- 可缓存热点数据

### 7.3 异步处理
- 异步处理耗时操作
- 线程池管理

## 八、部署配置

### 8.1 环境要求
- JDK 17+
- MySQL 8.0+
- MongoDB 6.0+
- Redis 6.0+
- Gitea（可选，用于模型文件存储）

### 8.2 配置文件
- `application.yml`: 主配置
- `application-dev.yml`: 开发环境
- `application-prod.yml`: 生产环境

### 8.3 启动方式
```bash
mvn clean install
mvn spring-boot:run
```

## 九、总结

Model Cloud 后端采用现代化的 Spring Boot 技术栈，通过合理的架构设计和模块划分，实现了模型管理的核心功能。系统集成了 Gitea 作为版本控制系统，使用 MySQL 和 MongoDB 分别存储结构化和非结构化数据，Redis 提供缓存服务。通过 Spring Security 和 JWT 实现了安全的认证授权机制，保证了系统的安全性和可扩展性。




